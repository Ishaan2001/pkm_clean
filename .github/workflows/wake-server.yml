name: Wake Render Server for Daily Notifications

on:
  schedule:
    # Run at 9:45 AM IST (4:15 AM UTC) every day with 8-minute keep-alive loop
    - cron: '15 4 * * *'
  workflow_dispatch: # Allow manual triggering for testing

jobs:
  wake-server:
    runs-on: ubuntu-latest
    
    steps:
    - name: Wake up and keep Render server alive
      run: |
        echo "ğŸš€ Starting server wake-up and keep-alive sequence at $(date)"
        
        # Function to hit server and verify it's awake
        check_server() {
          echo "â° Pinging server at $(date)"
          curl -X GET "https://pkm-clean.onrender.com/api/wake-server" \
            --max-time 30 \
            --silent \
            --write-out "HTTP Status: %{http_code}, Response Time: %{time_total}s\n" \
            || echo "âŒ Request failed"
        }
        
        # Initial wake-up with longer timeout
        echo "ğŸŒ… Initial server wake-up attempt..."
        curl -X GET "https://pkm-clean.onrender.com/api/wake-server" \
          --max-time 120 \
          --retry 3 \
          --retry-delay 10 \
          --connect-timeout 30 \
          -v || echo "âš ï¸ Initial wake-up had issues, continuing with keep-alive..."
        
        echo "âœ… Server should be starting up, beginning keep-alive loop..."
        
        # Keep-alive loop: Hit server every 60 seconds for 8 minutes
        # This ensures server stays awake regardless of when GitHub Actions actually started
        for i in {1..8}; do
          echo "ğŸ”„ Keep-alive ping #$i of 8"
          check_server
          
          # Don't sleep after the last iteration
          if [ $i -lt 8 ]; then
            echo "ğŸ’¤ Waiting 60 seconds before next ping..."
            sleep 60
          fi
        done
        
        # Final verification that scheduler is ready
        echo "ğŸ¯ Final verification - checking notification scheduler status..."
        curl -X GET "https://pkm-clean.onrender.com/api/push/scheduler/status" \
          --max-time 30 \
          -v || echo "âš ï¸ Scheduler status check failed"
        
        echo "ğŸ Keep-alive sequence completed at $(date)"
        echo "ğŸ“± Server should remain active for 10 AM IST notifications"
