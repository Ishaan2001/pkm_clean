name: Send Daily Push Notifications

on:
  schedule:
    # Run at 10:00 AM IST (4:30 AM UTC) every day - direct notification trigger
    - cron: '30 4 * * *'
  workflow_dispatch: # Allow manual triggering for testing

jobs:
  send-notifications:
    runs-on: ubuntu-latest
    
    steps:
    - name: Wake server and trigger daily notifications
      run: |
        echo "ğŸš€ Starting server wake-up and direct notification trigger at $(date)"
        
        # Function to hit server and verify it's awake
        check_server() {
          echo "â° Pinging server at $(date)"
          curl -X GET "https://pkm-clean.onrender.com/api/wake-server" \
            --max-time 30 \
            --silent \
            --write-out "HTTP Status: %{http_code}, Response Time: %{time_total}s\n" \
            || echo "âŒ Request failed"
        }
        
        # Initial wake-up with longer timeout
        echo "ğŸŒ… Initial server wake-up attempt..."
        curl -X GET "https://pkm-clean.onrender.com/api/wake-server" \
          --max-time 120 \
          --retry 3 \
          --retry-delay 10 \
          --connect-timeout 30 \
          -v || echo "âš ï¸ Initial wake-up had issues, continuing with keep-alive..."
        
        echo "âœ… Server should be starting up, beginning keep-alive loop..."
        
        # Keep-alive loop: Hit server every 60 seconds for 8 minutes
        # This ensures server stays awake regardless of when GitHub Actions actually started
        for i in {1..8}; do
          echo "ğŸ”„ Keep-alive ping #$i of 8"
          check_server
          
          # Don't sleep after the last iteration
          if [ $i -lt 8 ]; then
            echo "ğŸ’¤ Waiting 60 seconds before next ping..."
            sleep 60
          fi
        done
        
        # Instead of relying on internal scheduler, directly trigger notifications
        echo "ğŸ¯ Directly triggering daily notifications via API..."
        curl -X POST "https://pkm-clean.onrender.com/api/push/send-daily-notifications" \
          --max-time 60 \
          --header "Content-Type: application/json" \
          --write-out "HTTP Status: %{http_code}, Response Time: %{time_total}s\\n" \
          -v || echo "âš ï¸ Direct notification trigger failed"
        
        echo "ğŸ Notification trigger sequence completed at $(date)"
        echo "ğŸ“± Notifications sent directly via GitHub Actions (bypassing internal scheduler)"
